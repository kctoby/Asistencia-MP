--Función que le permitirá al empleado ver aquellos permisos aprobados y rechazados.

--Entrada: ID_EMPLEADO
--Salida: ID_PERMISO, TIPO_AUSENCIA, P_VEREDICTO
CREATE OR REPLACE FUNCTION "PERMISOS".F_VER_PERMISOS_APR_DNG(IN P_ID_EMPLEADO CHARACTER VARYING(10), 
								OUT P_ID_PERMISO INTEGER, 
								OUT P_TIPO_AUSENCIA CHARACTER VARYING(70),
								OUT P_VEREDICTO character varying(100)) 
RETURNS SETOF RECORD AS 
$BODY$
DECLARE
 v_fecha_actual date;
 BEGIN
     --Obtener fecha actual
     v_fecha_actual := CURRENT_DATE;

	RETURN QUERY ((SELECT B."ID_PERMISO", C."TIPO_AUSENCIA", 'PERMISO APROBADO'::CHARACTER VARYING
			FROM "PERMISOS"."TBL_PERMISOS" B
			INNER JOIN "PERMISOS"."TBL_TIPOS_AUSENCIAS" C
			ON(B."ID_TIPO_AUSENCIA" = C."ID_TIPO_AUSENCIA")
			WHERE B."ID_EMPLEADO" = P_ID_EMPLEADO AND B."ESTADO_REVERTIR_PERMISO" = FALSE AND
			(B."ESTADO_JEFE" = TRUE AND B."F_CAMBIO_ESTADO_JEFE" IS NOT NULL 
			AND B."ESTADO_JPERSONAL" = TRUE AND B."F_CAMBIO_ESTADO_JPERSONAL" IS NOT NULL AND B."VISTO" = FALSE))
		UNION 
		(SELECT D."ID_PERMISO", E."TIPO_AUSENCIA", 'PERMISO RECHAZADO'::CHARACTER VARYING
			FROM "PERMISOS"."TBL_PERMISOS" D
			INNER JOIN "PERMISOS"."TBL_TIPOS_AUSENCIAS" E
			ON(D."ID_TIPO_AUSENCIA" = E."ID_TIPO_AUSENCIA")
			WHERE D."ID_EMPLEADO" = P_ID_EMPLEADO AND D."ESTADO_REVERTIR_PERMISO" = FALSE AND
			((D."ESTADO_JEFE" = TRUE AND D."F_CAMBIO_ESTADO_JEFE" IS NOT NULL 
			AND D."ESTADO_JPERSONAL" = FALSE AND D."F_CAMBIO_ESTADO_JPERSONAL" IS NOT NULL AND D."VISTO" = FALSE) 
			OR (D."ESTADO_JEFE" = FALSE AND D."F_CAMBIO_ESTADO_JEFE" IS NOT NULL))));
 END;
$BODY$ 
LANGUAGE 'plpgsql';

--Ejecutar la función intento 4
SELECT * FROM "PERMISOS".F_VER_PERMISOS_APR_DNG('000035');